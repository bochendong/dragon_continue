"""
è¡€ç»Ÿå’Œè¨€çµæ•°æ®è¿ç§»è„šæœ¬
æ·»åŠ è§’è‰²è¡€ç»Ÿç­‰çº§å’Œè¨€çµä¿¡æ¯åˆ°æ•°æ®åº“
"""

import sys
import os
import sqlite3
sys.path.append(os.path.dirname(__file__))

from character_database import CharacterDatabase

def migrate_bloodline_and_spirit_words():
    """è¿ç§»è¡€ç»Ÿå’Œè¨€çµæ•°æ®"""
    
    # åˆ›å»ºæ•°æ®åº“å®ä¾‹ï¼Œä½¿ç”¨databaseç›®å½•ä¸‹çš„æ•°æ®åº“
    current_dir = os.path.dirname(os.path.abspath(__file__))
    db_path = os.path.join(current_dir, "dragon_characters.db")
    db = CharacterDatabase(db_path)
    
    print("æ­£åœ¨è¿ç§»è¡€ç»Ÿå’Œè¨€çµæ•°æ®...")
    
    # æ·»åŠ è¨€çµåº“
    print("æ­£åœ¨æ·»åŠ è¨€çµåº“...")
    
    # é’é“œä¸ç«ä¹‹ç‹ç³»åˆ—è¨€çµ
    db.add_spirit_word("å›ç„°", 89, "é’é“œä¸ç«ä¹‹ç‹", 
                      "äº§ç”Ÿæé«˜æ¸©åº¦çš„ç«ç„°ï¼Œèƒ½å¤Ÿç†”åŒ–é‡‘å±",
                      "äº§ç”Ÿæ•°åƒåº¦é«˜æ¸©çš„ç«ç„°ï¼ŒèŒƒå›´å¯è¾¾æ•°åç±³",
                      "éœ€è¦å¤§é‡ä½“åŠ›ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šå¯¼è‡´è¡€ç»Ÿæš´èµ°",
                      "é«˜å±")
    
    db.add_spirit_word("çƒ›é¾™", 90, "é’é“œä¸ç«ä¹‹ç‹",
                      "å¬å”¤çƒ›é¾™è™šå½±ï¼Œé‡Šæ”¾æ¯ç­æ€§çš„é¾™ç‚",
                      "å¬å”¤å·¨å¤§çš„é¾™å½¢ç«ç„°ï¼Œå¨åŠ›è¶³ä»¥æ‘§æ¯å»ºç­‘",
                      "éœ€è¦æé«˜è¡€ç»Ÿçº¯åº¦ï¼Œä½¿ç”¨åæåº¦è™šå¼±",
                      "é«˜å±")
    
    db.add_spirit_word("ç‚½æ—¥", 91, "é’é“œä¸ç«ä¹‹ç‹",
                      "åœ¨æŒå¿ƒå‡èšé«˜æ¸©ç«çƒ",
                      "äº§ç”Ÿå°å‹ä½†æé«˜æ¸©åº¦çš„ç«çƒ",
                      "éœ€è¦ç²¾ç¡®æ§åˆ¶ï¼Œå¦åˆ™ä¼šä¼¤åŠè‡ªèº«",
                      "é«˜å±")
    
    # å¤§åœ°ä¸å±±ä¹‹ç‹ç³»åˆ—è¨€çµ
    db.add_spirit_word("ç‹æƒ", 92, "å¤§åœ°ä¸å±±ä¹‹ç‹",
                      "æ§åˆ¶é‡åŠ›ï¼Œä½¿ç›®æ ‡æ‰¿å—å·¨å¤§å‹åŠ›",
                      "å¢åŠ ç›®æ ‡å‘¨å›´çš„é‡åŠ›ï¼Œä½¿å…¶æ— æ³•ç§»åŠ¨",
                      "å¯¹ä½¿ç”¨è€…ä¹Ÿæœ‰åä½œç”¨åŠ›",
                      "é«˜å±")
    
    db.add_spirit_word("é’é“œå¾¡åº§", 93, "å¤§åœ°ä¸å±±ä¹‹ç‹",
                      "å¼ºåŒ–èº«ä½“ï¼Œè·å¾—è¶…äººçš„åŠ›é‡å’Œé˜²å¾¡",
                      "èº«ä½“å˜å¾—å¦‚é’é“œèˆ¬åšç¡¬ï¼ŒåŠ›é‡å¤§å¹…æå‡",
                      "æŒç»­æ—¶é—´æœ‰é™ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šæŸå®³èº«ä½“",
                      "é«˜å±")
    
    # å¤©ç©ºä¸é£ä¹‹ç‹ç³»åˆ—è¨€çµ
    db.add_spirit_word("é£ç‹ä¹‹ç³", 94, "å¤©ç©ºä¸é£ä¹‹ç‹",
                      "æ§åˆ¶å‘¨å›´çš„é£å…ƒç´ ",
                      "å¯ä»¥äº§ç”Ÿå¼ºé£ã€é¾™å·é£ç­‰é£ç³»æ”»å‡»",
                      "éœ€è¦è‰¯å¥½çš„ç©ºæ°”æµé€šç¯å¢ƒ",
                      "é«˜å±")
    
    db.add_spirit_word("æ— å°˜ä¹‹åœ°", 95, "å¤©ç©ºä¸é£ä¹‹ç‹",
                      "åˆ›é€ æ— å°˜çš„çº¯å‡€ç©ºé—´",
                      "åœ¨å‘¨å›´åˆ›é€ çœŸç©ºç¯å¢ƒï¼Œé˜»æŒ¡ä¸€åˆ‡ç‰©è´¨",
                      "æ¶ˆè€—å·¨å¤§ï¼Œæ— æ³•ç»´æŒé•¿æ—¶é—´",
                      "é«˜å±")
    
    # æµ·æ´‹ä¸æ°´ä¹‹ç‹ç³»åˆ—è¨€çµ
    db.add_spirit_word("æ·±æ½œè€…", 96, "æµ·æ´‹ä¸æ°´ä¹‹ç‹",
                      "æ§åˆ¶æ°´æµï¼Œåœ¨æ°´ä¸­æœ‰æå¼ºä¼˜åŠ¿",
                      "å¯ä»¥æ§åˆ¶æ°´æµæ–¹å‘ã€é€Ÿåº¦ï¼Œåœ¨æ°´ä¸­è¡ŒåŠ¨è‡ªå¦‚",
                      "åœ¨æ°´ä¸­æ•ˆæœæœ€ä½³ï¼Œé™†åœ°æ•ˆæœå‡å¼±",
                      "é«˜å±")
    
    db.add_spirit_word("å½’å¢Ÿ", 97, "æµ·æ´‹ä¸æ°´ä¹‹ç‹",
                      "åˆ›é€ å·¨å¤§çš„æ¼©æ¶¡",
                      "äº§ç”Ÿå¼ºå¤§çš„æ°´æµæ¼©æ¶¡ï¼Œå¯ä»¥åå™¬ä¸€åˆ‡",
                      "éœ€è¦å¤§é‡æ°´æºï¼Œåœ¨å¹²ç‡¥ç¯å¢ƒæ— æ•ˆ",
                      "é«˜å±")
    
    # ä¸€äº›å¸¸è§çš„ä½åºåˆ—è¨€çµ
    db.add_spirit_word("è›‡", 16, "æœªçŸ¥é¾™ç‹",
                      "å¢å¼ºæ„ŸçŸ¥èƒ½åŠ›ï¼Œå¯ä»¥æ„ŸçŸ¥å‘¨å›´çš„ç”Ÿå‘½ä½“",
                      "æ‰©å¤§æ„ŸçŸ¥èŒƒå›´ï¼Œå‘ç°éšè—çš„æ•Œäºº",
                      "æ„ŸçŸ¥èŒƒå›´æœ‰é™ï¼Œå®¹æ˜“è¢«å¹²æ‰°",
                      "æ™®é€š")
    
    db.add_spirit_word("é•°é¼¬", 59, "å¤©ç©ºä¸é£ä¹‹ç‹",
                      "å¢å¼ºå¬è§‰ï¼Œå¯ä»¥å¬åˆ°æç»†å¾®çš„å£°éŸ³",
                      "å¬åŠ›å¤§å¹…å¢å¼ºï¼Œå¯ä»¥å¬åˆ°å¾ˆè¿œçš„å¯¹è¯",
                      "åœ¨å˜ˆæ‚ç¯å¢ƒä¸­æ•ˆæœä¼šå—å½±å“",
                      "æ™®é€š")
    
    db.add_spirit_word("è¨€çµÂ·é•œç³", 5, "æœªçŸ¥é¾™ç‹",
                      "å¢å¼ºè§†è§‰ï¼Œå¯ä»¥çœ‹æ¸…æè¿œè·ç¦»",
                      "è§†åŠ›å¤§å¹…å¢å¼ºï¼Œå¯ä»¥çœ‹æ¸…è¿œè·ç¦»çš„ç»†èŠ‚",
                      "å¼ºå…‰ç¯å¢ƒå¯èƒ½é€ æˆçœ¼ç›ä¸é€‚",
                      "æ™®é€š")
    
    # æ·»åŠ è§’è‰²è¡€ç»Ÿä¿¡æ¯
    print("æ­£åœ¨æ·»åŠ è§’è‰²è¡€ç»Ÿä¿¡æ¯...")
    # å…ˆåˆ é™¤æ—§çš„è¡€ç»Ÿä¿¡æ¯
    with sqlite3.connect(db.db_path) as conn:
        conn.execute("DELETE FROM character_bloodline")
        conn.commit()
    
    # è·¯æ˜éè¡€ç»Ÿ
    db.add_bloodline_info("è·¯æ˜é", "Sçº§", 50, "é»‘ç‹è¡€ç»Ÿ",
                         "æ‹¥æœ‰æé«˜çš„é¾™æ—è¡€ç»Ÿçº¯åº¦ï¼Œä½†è¢«å°å°ï¼Œå¹³æ—¶è¡¨ç°æ™®é€š")
    
    # è·¯é¸£æ³½è¡€ç»Ÿï¼ˆç¬¬ä¸€éƒ¨è®¾å®šï¼šèº«ä»½æœªå…¬å¼€ï¼‰
    db.add_bloodline_info("è·¯é¸£æ³½", "Sçº§", 90, "æœªçŸ¥é¾™ç‹è¡€ç»Ÿ",
                         "æé«˜çº¯åº¦è¡€ç»Ÿï¼Œä½†çœŸå®èº«ä»½åœ¨ç¬¬ä¸€éƒ¨ä¸­å°šæœªæ­ç¤º")
    
    # å‡¯æ’’è¡€ç»Ÿ
    db.add_bloodline_info("å‡¯æ’’", "Açº§", 75, "æœªçŸ¥é¾™ç‹è¡€ç»Ÿ",
                         "æ¥è‡ªåŠ å›¾ç´¢å®¶æ—çš„é«˜çº¯åº¦è¡€ç»Ÿï¼Œå…·æœ‰å¼ºå¤§çš„æˆ˜æ–—èƒ½åŠ›")
    
    # è¯ºè¯ºè¡€ç»Ÿ
    db.add_bloodline_info("è¯ºè¯º", "Açº§", 80, "æœªçŸ¥é¾™ç‹è¡€ç»Ÿ",
                         "ç¥ç§˜çš„é«˜çº¯åº¦è¡€ç»Ÿï¼Œæ‹¥æœ‰ç‰¹æ®Šçš„æ„ŸçŸ¥èƒ½åŠ›")
    
    # æ¥šå­èˆªè¡€ç»Ÿ
    db.add_bloodline_info("æ¥šå­èˆª", "Açº§", 70, "å¤§åœ°ä¸å±±ä¹‹ç‹è¡€ç»Ÿ",
                         "é«˜çº¯åº¦è¡€ç»Ÿï¼Œåœ¨å‰‘é“æ–¹é¢æœ‰ç‰¹æ®Šå¤©èµ‹")
    
    # é™ˆé›¯é›¯è¡€ç»Ÿ
    db.add_bloodline_info("é™ˆé›¯é›¯", "æ™®é€šäºº", 0, "æ— é¾™æ—è¡€ç»Ÿ",
                         "å®Œå…¨çš„äººç±»ï¼Œæ²¡æœ‰ä»»ä½•é¾™æ—è¡€ç»Ÿ")
    
    # å¤å¼¥è¡€ç»Ÿï¼ˆç¬¬ä¸€éƒ¨è®¾å®šï¼šèº«ä»½æœªå…¬å¼€ï¼‰
    db.add_bloodline_info("å¤å¼¥", "Açº§", 85, "æœªçŸ¥é¾™ç‹è¡€ç»Ÿ",
                         "é«˜çº¯åº¦è¡€ç»Ÿï¼Œä½†çœŸå®èº«ä»½åœ¨ç¬¬ä¸€éƒ¨ä¸­å°šæœªæ­ç¤º")
    
    # ä¸ºè§’è‰²æ·»åŠ è¨€çµ
    print("æ­£åœ¨ä¸ºè§’è‰²æ·»åŠ è¨€çµ...")
    
    # è·¯æ˜éçš„è¨€çµ
    db.add_character_spirit_word("è·¯æ˜é", "è›‡", 3, "æƒ…ç»ªæ¿€åŠ¨æ—¶", "ä¸»è¦æ„ŸçŸ¥è¨€çµ")
    db.add_character_spirit_word("è·¯æ˜é", "è¨€çµÂ·é•œç³", 2, "ä¸“æ³¨æ—¶", "è¾…åŠ©è§†è§‰è¨€çµ")
    
    # è·¯é¸£æ³½çš„è¨€çµ
    db.add_character_spirit_word("è·¯é¸£æ³½", "å›ç„°", 5, "æ„¤æ€’æ—¶", "ä¸»è¦æ”»å‡»è¨€çµ")
    db.add_character_spirit_word("è·¯é¸£æ³½", "çƒ›é¾™", 4, "æåº¦æ„¤æ€’æ—¶", "ç»ˆæè¨€çµ")
    db.add_character_spirit_word("è·¯é¸£æ³½", "ç‚½æ—¥", 5, "æˆ˜æ–—æ—¶", "ç²¾ç¡®æ§åˆ¶è¨€çµ")
    
    # å‡¯æ’’çš„è¨€çµ
    db.add_character_spirit_word("å‡¯æ’’", "é•°é¼¬", 4, "éœ€è¦æ—¶", "æ„ŸçŸ¥ç±»è¨€çµ")
    db.add_character_spirit_word("å‡¯æ’’", "é’é“œå¾¡åº§", 3, "æˆ˜æ–—æ—¶", "å¼ºåŒ–èº«ä½“è¨€çµ")
    
    # è¯ºè¯ºçš„è¨€çµ
    db.add_character_spirit_word("è¯ºè¯º", "è›‡", 4, "éœ€è¦æ—¶", "ä¸»è¦æ„ŸçŸ¥è¨€çµ")
    db.add_character_spirit_word("è¯ºè¯º", "è¨€çµÂ·é•œç³", 3, "ä¸“æ³¨æ—¶", "è§†è§‰å¢å¼ºè¨€çµ")
    
    # æ¥šå­èˆªçš„è¨€çµ
    db.add_character_spirit_word("æ¥šå­èˆª", "ç‹æƒ", 4, "æˆ˜æ–—æ—¶", "ä¸»è¦æ”»å‡»è¨€çµ")
    db.add_character_spirit_word("æ¥šå­èˆª", "é’é“œå¾¡åº§", 3, "éœ€è¦å¼ºåŒ–æ—¶", "èº«ä½“å¼ºåŒ–è¨€çµ")
    
    # å¤å¼¥çš„è¨€çµï¼ˆç¬¬ä¸€éƒ¨è®¾å®šï¼šéšè—çœŸå®å®åŠ›ï¼‰
    db.add_character_spirit_word("å¤å¼¥", "è›‡", 3, "æ¢æµ‹æ—¶", "è¾…åŠ©æ¢æµ‹è¨€çµ")
    db.add_character_spirit_word("å¤å¼¥", "è¨€çµÂ·é•œç³", 2, "è§‚å¯Ÿæ—¶", "è§‚å¯Ÿåˆ†æè¨€çµ")
    
    # æ³¨æ„ï¼šé™ˆé›¯é›¯æ˜¯æ™®é€šäººï¼Œæ²¡æœ‰è¨€çµ
    
    print("è¡€ç»Ÿå’Œè¨€çµæ•°æ®è¿ç§»å®Œæˆï¼")
    
    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    stats = db.get_database_stats()
    print(f"\næ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯:")
    print(f"- è§’è‰²æ•°é‡: {stats['character_count']}")
    print(f"- è¡€ç»Ÿè®°å½•: {stats['bloodline_count']}")
    print(f"- è¨€çµæ•°é‡: {stats['spirit_word_count']}")
    print(f"- è§’è‰²è¨€çµå…³è”: {stats['character_spirit_word_count']}")
    
    return db

def test_bloodline_and_spirit_words():
    """æµ‹è¯•è¡€ç»Ÿå’Œè¨€çµåŠŸèƒ½"""
    print("\n=== æµ‹è¯•è¡€ç»Ÿå’Œè¨€çµåŠŸèƒ½ ===")
    
    # ä½¿ç”¨ä¸è¿ç§»å‡½æ•°ç›¸åŒçš„æ•°æ®åº“è·¯å¾„
    current_dir = os.path.dirname(os.path.abspath(__file__))
    db_path = os.path.join(current_dir, "dragon_characters.db")
    db = CharacterDatabase(db_path)
    
    # æµ‹è¯•è§’è‰²è¡€ç»ŸæŸ¥è¯¢
    print("\nğŸ§¬ è§’è‰²è¡€ç»Ÿä¿¡æ¯:")
    characters = ["è·¯æ˜é", "è·¯é¸£æ³½", "å‡¯æ’’", "è¯ºè¯º", "æ¥šå­èˆª"]
    for name in characters:
        bloodline = db.get_character_bloodline(name)
        if bloodline:
            print(f"{name}: {bloodline['bloodline_level']} ({bloodline['bloodline_percentage']}%)")
        else:
            print(f"{name}: æ— è¡€ç»Ÿè®°å½•")
    
    # æµ‹è¯•è§’è‰²è¨€çµæŸ¥è¯¢
    print("\nâš¡ è§’è‰²è¨€çµä¿¡æ¯:")
    for name in characters:
        spirit_words = db.get_character_spirit_words(name)
        if spirit_words:
            print(f"\n{name}:")
            for sw in spirit_words:
                print(f"  - {sw['name']} (åºåˆ—{sw['sequence_number']}, ç­‰çº§{sw['mastery_level']})")
        else:
            print(f"{name}: æ— è¨€çµè®°å½•")
    
    # æµ‹è¯•è¨€çµåº“æŸ¥è¯¢
    print("\nğŸ“š è¨€çµåº“ç»Ÿè®¡:")
    all_spirit_words = db.get_all_spirit_words()
    print(f"æ€»è¨€çµæ•°é‡: {len(all_spirit_words)}")
    
    # æŒ‰é¾™ç‹åˆ†ç±»
    dragon_counts = {}
    for sw in all_spirit_words:
        dragon = sw['dragon_name']
        dragon_counts[dragon] = dragon_counts.get(dragon, 0) + 1
    
    print("æŒ‰é¾™ç‹åˆ†ç±»:")
    for dragon, count in dragon_counts.items():
        print(f"  {dragon}: {count}ä¸ªè¨€çµ")
    
    # æµ‹è¯•è¨€çµæœç´¢
    print("\nğŸ” è¨€çµæœç´¢æµ‹è¯•:")
    search_terms = ["ç«", "é£", "å¤§åœ°", "æ°´"]
    for term in search_terms:
        results = db.search_spirit_words(term)
        names = [sw['name'] for sw in results]
        print(f"æœç´¢ '{term}': {', '.join(names) if names else 'æ— ç»“æœ'}")

if __name__ == "__main__":
    db = migrate_bloodline_and_spirit_words()
    test_bloodline_and_spirit_words()
